
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://sparkutils.github.io/quality/0.0.2-SNAPSHOT/advanced/userFunctions/">
      
      
        <link rel="prev" href="../aggregations/">
      
      
        <link rel="next" href="../prng/">
      
      <link rel="icon" href="../../img/quality.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>User Defined Functions - Quality</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/site.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#what-about-default-parameter-or-different-length-parameter-length-lambdas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Quality" class="md-header__button md-logo" aria-label="Quality" data-md-component="logo">
      
  <img src="../../img/quality.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quality
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Defined Functions
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/sparkutils/quality/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Quality
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../background/about/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../model/" class="md-tabs__link">
        Model
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../blooms/" class="md-tabs__link md-tabs__link--active">
        Advanced Usage
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../site/" class="md-tabs__link">
      Maven Site
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../site/scaladocs/com/sparkutils/quality/" class="md-tabs__link">
      Scala Docs
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../sqlfunctions/" class="md-tabs__link">
      SQL Functions Documentation
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Quality" class="md-nav__button md-logo" aria-label="Quality" data-md-component="logo">
      
  <img src="../../img/quality.png" alt="logo">

    </a>
    Quality
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sparkutils/quality/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Quality
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        Building and Setting Up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/a_first_rulesuite/" class="md-nav__link">
        Defining & Running your first RuleSuite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/flavours/" class="md-nav__link">
        Those are some Quality flavours
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/key_functions/" class="md-nav__link">
        Key SQL Functions to use in your Rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/serializing/" class="md-nav__link">
        Reading & Writing RuleSuites
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/running_on_databricks/" class="md-nav__link">
        Running Quality on Databricks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/about/" class="md-nav__link">
        History
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Performance Choices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Performance Choices
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/evaluation_method/" class="md-nav__link">
        Evaluation Method
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/storage_method/" class="md-nav__link">
        Storage Method
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Model
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Model
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/" class="md-nav__link">
        Rule Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/storage/" class="md-nav__link">
        Storage Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/meta/" class="md-nav__link">
        Meta Rulesets?
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Advanced Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Advanced Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blooms/" class="md-nav__link">
        Bloom Filters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mapFunctions/" class="md-nav__link">
        Map Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aggregations/" class="md-nav__link">
        Aggregation Functions
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          User Defined Functions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        User Defined Functions
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-about-default-parameter-or-different-length-parameter-length-lambdas" class="md-nav__link">
    What about default parameter or different length parameter length Lambdas?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#higher-order-functions" class="md-nav__link">
    Higher Order Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controlling-compilation-tweaking-the-quality-optimisations" class="md-nav__link">
    Controlling compilation - Tweaking the Quality Optimisations
  </a>
  
    <nav class="md-nav" aria-label="Controlling compilation - Tweaking the Quality Optimisations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-do-all-this" class="md-nav__link">
    Why do all this?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prng/" class="md-nav__link">
        PRNG Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rowIdFunctions/" class="md-nav__link">
        Row ID Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
      
      
      
        <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
          QualityRules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_7">
          <span class="md-nav__icon md-icon"></span>
          QualityRules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleEngine/" class="md-nav__link">
        Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleEngineWorkflow/" class="md-nav__link">
        Workflow
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleFolder/" class="md-nav__link">
        QualityFolder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../expressionDocs/" class="md-nav__link">
        Expression Documentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../site/" class="md-nav__link">
        Maven Site
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../site/scaladocs/com/sparkutils/quality/" class="md-nav__link">
        Scala Docs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sqlfunctions/" class="md-nav__link">
        SQL Functions Documentation
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-about-default-parameter-or-different-length-parameter-length-lambdas" class="md-nav__link">
    What about default parameter or different length parameter length Lambdas?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#higher-order-functions" class="md-nav__link">
    Higher Order Functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controlling-compilation-tweaking-the-quality-optimisations" class="md-nav__link">
    Controlling compilation - Tweaking the Quality Optimisations
  </a>
  
    <nav class="md-nav" aria-label="Controlling compilation - Tweaking the Quality Optimisations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-do-all-this" class="md-nav__link">
    Why do all this?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>User Defined Functions</h1>

<p>Users may register Lambda Functions using the sql lambda syntax:
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;multValCCY&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(theValue, ccy) -&gt; theValue * ccy&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">registerLambdaFunctions</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="n">rule</span><span class="p">))</span>
</code></pre></div>
they may be then called in rules (or within any SQL expressions), in this case value and ccyrate from the data frame are provided to the function as parameters theValue and ccy: 
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">ndf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;newcalc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">(</span><span class="s">&quot;multValCCY(value, ccyrate)&quot;</span><span class="p">))</span>
</code></pre></div>
The function parameter and return types are derived during the analysis phase, this may lead to errors if types do not match the expressions upon an action only, such as writing or calling show.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Whilst you are free to add lambdas when not using a RuleSuite the library will not ensure that only functions registered as part of a RuleSuite are used in rules, such hygiene is necessarily left to the user.</p>
</div>
<p>LambdaFunctions may have any number of parameters e.g. given a <em>greaterThan</em> lambda:
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="p">(</span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">param2</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">param1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">param2</span>
</code></pre></div>
  you would be able to call it with two expressions
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">greaterThan</span><span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="w"> </span><span class="n">col2</span><span class="p">)</span>
</code></pre></div></p>
<p>Single argument lambdas should not use brackets around the parameters and zero argument lambdas use no input or -&gt;.  In all cases the lambda can use the attributes from the surrounding dataframe - it's effectively global, you cannot use variables from surrounding / calling lambdas.</p>
<details class="warning"><summary>Don't use 'current'&hellip; as a lambda variable name on 2.4</summary><p>Bizarrely this causes the parser to fail on 2.4 only, no more recent version suffers this.  Same goes for left or right as names.</p>
</details>
<h2 id="what-about-default-parameter-or-different-length-parameter-length-lambdas">What about default parameter or different length parameter length Lambdas?<a class="headerlink" href="#what-about-default-parameter-or-different-length-parameter-length-lambdas" title="Permanent link">&para;</a></h2>
<p>To define multiple parameter length lambdas just define new lambdas with the same name but different argument lengths.  You can freely call the same lambda name with different parameters e.g.:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;multValCCY&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;multValCCY(value, ccyrate)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">rule1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;multValCCY&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;theValue -&gt; multValCCY(theValue, ccyrate)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">rule2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;multValCCY&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(theValue, ccy) -&gt; theValue * ccy&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">registerLambdaFunctions</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span><span class="w"> </span><span class="n">rule1</span><span class="p">,</span><span class="w"> </span><span class="n">rule2</span><span class="p">))</span>

<span class="c1">// all of these should work</span>
<span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;newcalc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">(</span><span class="s">&quot;multValCCY()&quot;</span><span class="p">))</span>
<span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;newcalc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">(</span><span class="s">&quot;multValCCY(value)&quot;</span><span class="p">))</span>
<span class="n">df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;newcalc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">(</span><span class="s">&quot;multValCCY(value, ccyrate)&quot;</span><span class="p">))</span>
</code></pre></div>
<h2 id="higher-order-functions">Higher Order Functions<a class="headerlink" href="#higher-order-functions" title="Permanent link">&para;</a></h2>
<p>As Lambda's in Spark aren't first class citizens you can neither partially apply them (fill in parameters to derive new lambdas) nor pass them into a lambda.</p>
<p>In 0.7.1 Quality experimentally adds three new concepts to the mix:</p>
<ol>
<li>Placeholders - <code class="highlight"><span class="n">_</span><span class="p">()</span></code> - which represents a value which still needs to be filled (partial application)</li>
<li>Application - <code class="highlight"><span class="n">callFun</span><span class="p">()</span></code> - which, in a lambda, allows you to apply a function parameter</li>
<li>Lambda Extraction - <code class="highlight"><span class="n">_lambda_</span><span class="p">()</span></code> - which allows Lambdas to be used with existing Spark HigherOrderFunctions (like <a href="https://spark.apache.org/docs/latest/api/sql/index.html#aggregate">aggregate</a>) </li>
</ol>
<p>Unfortunately the last piece of that puzzle of returning a higher order function isn't currently possible.</p>
<p>Putting together 1 and 3 (straight out of the test suite):</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">plus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b) -&gt; a + b&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">plus3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b, c) -&gt; a + b + c&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">hof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;hof&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;func -&gt; aggregate(array(1, 2, 3), 0, _lambda_(func))&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">registerLambdaFunctions</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="n">plus</span><span class="p">,</span><span class="w"> </span><span class="n">plus3</span><span class="p">,</span><span class="w"> </span><span class="n">hof</span><span class="p">))</span>

<span class="k">import</span><span class="w"> </span><span class="nn">sparkSession</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="c1">// attempt to dropping a reference to a function where simple lambdas are expected.</span>
<span class="c1">// control</span>
<span class="n">assert</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT aggregate(array(1, 2, 3), 0, (acc, x) -&gt; acc + x) as res&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">[</span><span class="nc">Int</span><span class="p">].</span><span class="n">head</span><span class="p">)</span>
<span class="c1">// all params would be needed with multiple aritys</span>
<span class="n">assert</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT aggregate(array(1, 2, 3), 0, _lambda_(plus(_(&#39;int&#39;), _(&#39;int&#39;)))) as res&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">[</span><span class="nc">Int</span><span class="p">].</span><span class="n">head</span><span class="p">)</span>
<span class="c1">// can we play with partials?</span>
<span class="n">assert</span><span class="p">(</span><span class="mi">21</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT aggregate(array(1, 2, 3), 0, _lambda_(plus3(_(&#39;int&#39;), _(&#39;int&#39;), 5))) as res&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">[</span><span class="nc">Int</span><span class="p">].</span><span class="n">head</span><span class="p">)</span>
<span class="c1">// hof&#39;d</span>
<span class="n">assert</span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT hof(plus(_(&#39;int&#39;), _(&#39;int&#39;))) as res&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">[</span><span class="nc">Int</span><span class="p">].</span><span class="n">head</span><span class="p">)</span>
</code></pre></div>
<p>In the above example you can see type's being specified to the placeholder function, this is needed because, similar to aggExpr, Spark can't know the types until after they are evaluated and resolved.  This does have the benefit of keeping the types at the partial application site. <em>The default placeholder type is Long / Bigint</em>.</p>
<p>The <em>lambda</em> function extracts a fully <em>resolved</em> underlying Spark LambdaFunction, which means the types must be correct as it is provided to the function (use the placeholder function to specify types).  Similarly, you use the <em>lambda</em> function to extract the Spark LambdaFunction from a user provided parameter (as seen in the hof example).</p>
<p>The aggregate function only accepts two parameters for its accumulator, but in the plus3 example we've 'injected' in a third.  Partially applying the plus3 with the value 5 in it's "c" position leaves the two arguments as new function.  Quality ensures the necessary transformations are done before it hits the aggregate expression.</p>
<p>Great, but can I use it with aggExpr?  Yep:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">aggExpr</span><span class="p">(</span><span class="s1">&#39;DECIMAL(38,18)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">dec</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">myinc</span><span class="p">(</span><span class="n">_</span><span class="p">()),</span><span class="w"> </span><span class="n">myretsum</span><span class="p">(</span><span class="n">_</span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="p">()))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">agg</span>
</code></pre></div>
<p>allows you to define the myinc and myretsum elsewhere, you don't need to use the <em>lambda</em> function with aggExpr.</p>
<p>What about application?  Using callFun:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;use&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(func, b) -&gt; callFun(func, b)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="w">   </span>
</code></pre></div>
<p>the first parameter must be the lambda variable referring to your function followed by the necessary parameters to pass in.  Func in this case has a single parameter but of course it could have started with 5 and had 4 partially applied.  Again you don't need to use <em>lambda</em> to pass the functions further down the line:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">deep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;deep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(func, a, b) -&gt; use(func, a, b)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div>
<p>Deep takes the function and simply passes it to use where the callFun exists.</p>
<p>Finally you can also further partially apply your lambda variables:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">plus2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b) -&gt; a + b&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">plus3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b, c) -&gt; plus(plus(a, b), c)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">papplyt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;papplyt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(func, a, b, c) -&gt; callFun(callFun(func, _(), _(), c), a, b)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">registerLambdaFunctions</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="n">plus2</span><span class="p">,</span><span class="w"> </span><span class="n">plus3</span><span class="p">,</span><span class="w"> </span><span class="n">papplyt</span><span class="p">))</span>

<span class="k">import</span><span class="w"> </span><span class="nn">sparkSession</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="n">assert</span><span class="p">(</span><span class="il">6L</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;select papplyt(plus(_(), _(), _()), 1L, 2L, 3L) as res&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">[</span><span class="nc">Long</span><span class="p">].</span><span class="n">head</span><span class="p">)</span>
</code></pre></div>
<p>Here the callFun directly applies the function afterwards but you could equally pass it to other functions.</p>
<div class="highlight"><pre><span></span><code><span class="n">callFun</span><span class="p">(</span><span class="n">callFun</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">(),</span><span class="w"> </span><span class="n">_</span><span class="p">(),</span><span class="w"> </span><span class="n">c</span><span class="p">),</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>
<p>can then be read as partially apply func (plus with 3 arguments) parameter 3 with the lambda variable c, creating a new two argument function.  Then call that function with the a and b parameters.  Useless in this case perhaps but it should be illustrative. </p>
<p>All that's missing is returning lambdas:</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">plus2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b) -&gt; a + b&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">plus3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;plus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b, c) -&gt; plus(plus(a, b), c)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">retLambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">LambdaFunction</span><span class="p">(</span><span class="s">&quot;retLambda&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;(a, b) -&gt; plus(a, b, _())&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Id</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">registerLambdaFunctions</span><span class="p">(</span><span class="nc">Seq</span><span class="p">(</span><span class="n">plus2</span><span class="p">,</span><span class="w"> </span><span class="n">plus3</span><span class="p">,</span><span class="w"> </span><span class="n">retLambda</span><span class="p">))</span>

<span class="k">import</span><span class="w"> </span><span class="nn">sparkSession</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="n">assert</span><span class="p">(</span><span class="il">6L</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;select callFun(retLambda(1L, 2L), 3L) as res&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">sql</span><span class="p">.</span><span class="n">as</span><span class="p">[</span><span class="nc">Long</span><span class="p">].</span><span class="n">head</span><span class="p">})</span>
</code></pre></div>
<p>here the user function retLambda returns the plus with 3 arity applied over a and b, leaving a function of one arity to fill.  The top level callFun then applies the last argument (c).</p>
<p>The second test </p>
<details class="warning"><summary>It is experimental</summary><p>Although behaviour has been tested with compilation and across the support DBRs it's entirely possible there are gaps in the trickery used.</p>
<p>A good example of the experimental nature is the _() function, it's quite possible that is taken by Spark at a later stage.</p>
</details>
<details class="warning"><summary><em>lambda</em> drop in call arguments to transform_values and transform_keys don't work on 3.0 and 3.1.2/3</summary><p>They pattern match on List and not seq, later versions fix this.  To work around this you must explicitly use lambdas for these functions.</p>
</details>
<h2 id="controlling-compilation-tweaking-the-quality-optimisations">Controlling compilation - Tweaking the Quality Optimisations<a class="headerlink" href="#controlling-compilation-tweaking-the-quality-optimisations" title="Permanent link">&para;</a></h2>
<p>Normal Spark LambdaFunctions, NamedLambdaVariable and HigherOrderFunctions aren't compiled, this is - in part - due to the nature of having to thread the lambda variables across the Expression tree and calling bind.</p>
<p>At the time of codegen bind has already been called however so the code is free to create a new tree just for compilation.  Quality makes use of this and replaces all NamedLambdaVariables expressions with a simple variable in the generated code.</p>
<p>NamedLambdaVariables also use AtomicReferences, which was introduced to avoid a tree manipulation task - see <a href="https://github.com/apache/spark/pull/21954">here</a> for the code introduction.  AtomicReferences are slower for both writes and reads of non-contended variables.  As such Quality does away with this in its compilation, the exprId is sufficient to track the actual id.</p>
<p>Quality only attempts to replace it's own FunN and reverts to using NamedLambdaVariables if it encounters any other HigherOrderFunction.  Where it can replace it uses NamedLambdaVariableCodeGen with an ExprId specific code snippet.</p>
<p>You can customise this logic via implementing:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">trait</span><span class="w"> </span><span class="nc">LambdaCompilationHandler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     *</span>
<span class="cm">     * @param expr</span>
<span class="cm">     * @return empty if the expression should be transformed (i.e. there is a custom solution for it).  Otherwise return the full set of NamedLambdaVariables found</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">shouldTransform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Expression</span><span class="p">):</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">NamedLambdaVariable</span><span class="p">]</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Transform the expression using the scope of replaceable named lambda variable expression</span>
<span class="cm">     * @param expr</span>
<span class="cm">     * @param scope</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Expression</span><span class="p">,</span><span class="w"> </span><span class="n">scope</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">ExprId</span><span class="p">,</span><span class="w"> </span><span class="nc">NamedLambdaVariableCodeGen</span><span class="p">]):</span><span class="w"> </span><span class="nc">Expression</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>and supplying it via the environment variable, System.property or via sparkSession.sparkContext.setLocalProperty quality.lambdaHandlers using this format:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">className</span>
</code></pre></div>
<p>where name is either a fully qualified class name of a HigherOrderFunction or of a lambda (FunN) function.</p>
<p>The default org.apache.spark.sql.qualityFunctions.DoCodegenFallbackHandler allows you to disable any optimisation for a HigherOrderFunction.  It can be used to disable all FunN optimisations with:</p>
<div class="highlight"><pre><span></span><code>-Dquality.lambdaHandlers=org.apache.spark.sql.qualityFunctions.FunN=org.apache.spark.sql.qualityFunctions.DoCodegenFallbackHandler
</code></pre></div>
<p>Alternatively if you have a hotspot with any inbuilt HoF such as array_transform, filter or transform_values you could replace the implementation for compilation with your own transformation. e.g.:</p>
<div class="highlight"><pre><span></span><code>-Dquality.lambdaHandlers=org.apache.spark.sql.catalyst.expressions.TransformValues=org.mine.SuperfastTransformValues
</code></pre></div>
<h3 id="why-do-all-this">Why do all this?<a class="headerlink" href="#why-do-all-this" title="Permanent link">&para;</a></h3>
<p>Speed, it's up to 40% faster. LambdaRowPerfTest, in the test suite, generates an increasing number of lambdas and only runs over 10k rows but still sees clear benefits e.g. (orange is compiled lambdas):</p>
<p><img alt="Performance of lambdas compiled, orange, vs eval" src="../../img/lambdaCompilationPerf.png" /></p>
<p>This difference is already noticeable with a small increment function in a folder:</p>
<div class="highlight"><pre><span></span><code><span class="n">thecurrent</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">updateField</span><span class="p">(</span><span class="n">thecurrent</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;thecount&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">thecurrent</span><span class="p">.</span><span class="n">thecount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>The difference is typically higher with nested lambdas.  Should your compilation time exceed the execution time you may wish to disable compilation via the fallback handler.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 2, 2023 22:35:34</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 2, 2023 22:35:34</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.expand", "content.code.copy"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
        <script src="../../js/jquery-3.6.3.min.js"></script>
      
        <script src="../../js/tagflipper.js"></script>
      
    
  </body>
</html>