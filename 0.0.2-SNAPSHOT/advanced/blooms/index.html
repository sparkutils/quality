
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://sparkutils.github.io/quality/0.0.2-SNAPSHOT/advanced/blooms/">
      
      
        <link rel="prev" href="../../model/meta/">
      
      
        <link rel="next" href="../mapFunctions/">
      
      <link rel="icon" href="../../img/quality.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>Bloom Filters - Quality</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/site.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bloom-filters" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Quality" class="md-header__button md-logo" aria-label="Quality" data-md-component="logo">
      
  <img src="../../img/quality.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quality
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bloom Filters
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/sparkutils/quality/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Quality
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../getting_started/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../background/about/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../model/" class="md-tabs__link">
        Model
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Advanced Usage
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../site/" class="md-tabs__link">
      Maven Site
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../site/scaladocs/com/sparkutils/quality/" class="md-tabs__link">
      Scala Docs
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../sqlfunctions/" class="md-tabs__link">
      SQL Functions Documentation
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Quality" class="md-nav__button md-logo" aria-label="Quality" data-md-component="logo">
      
  <img src="../../img/quality.png" alt="logo">

    </a>
    Quality
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sparkutils/quality/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Quality
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        Building and Setting Up
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/a_first_rulesuite/" class="md-nav__link">
        Defining & Running your first RuleSuite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/flavours/" class="md-nav__link">
        Those are some Quality flavours
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/key_functions/" class="md-nav__link">
        Key SQL Functions to use in your Rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/serializing/" class="md-nav__link">
        Reading & Writing RuleSuites
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/running_on_databricks/" class="md-nav__link">
        Running Quality on Databricks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/about/" class="md-nav__link">
        History
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Performance Choices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Performance Choices
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/evaluation_method/" class="md-nav__link">
        Evaluation Method
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/storage_method/" class="md-nav__link">
        Storage Method
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Model
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Model
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/" class="md-nav__link">
        Rule Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/storage/" class="md-nav__link">
        Storage Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../model/meta/" class="md-nav__link">
        Meta Rulesets?
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Advanced Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Advanced Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Bloom Filters
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Bloom Filters
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-does-quality-change-this" class="md-nav__link">
    How does Quality change this?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-bloom-maps" class="md-nav__link">
    What are Bloom Maps?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-spark-stats-package" class="md-nav__link">
    Using the Spark stats package
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-quality-bloom-filters" class="md-nav__link">
    Using the Quality bloom filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#expressions-which-take-expression-parameters" class="md-nav__link">
    Expressions which take expression parameters
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mapFunctions/" class="md-nav__link">
        Map Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aggregations/" class="md-nav__link">
        Aggregation Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../userFunctions/" class="md-nav__link">
        User Defined Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prng/" class="md-nav__link">
        PRNG Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rowIdFunctions/" class="md-nav__link">
        Row ID Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
      
      
      
        <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
          QualityRules
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_7">
          <span class="md-nav__icon md-icon"></span>
          QualityRules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleEngine/" class="md-nav__link">
        Engine
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleEngineWorkflow/" class="md-nav__link">
        Workflow
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ruleFolder/" class="md-nav__link">
        QualityFolder
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../expressionDocs/" class="md-nav__link">
        Expression Documentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../site/" class="md-nav__link">
        Maven Site
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../site/scaladocs/com/sparkutils/quality/" class="md-nav__link">
        Scala Docs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sqlfunctions/" class="md-nav__link">
        SQL Functions Documentation
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-does-quality-change-this" class="md-nav__link">
    How does Quality change this?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-bloom-maps" class="md-nav__link">
    What are Bloom Maps?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-spark-stats-package" class="md-nav__link">
    Using the Spark stats package
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-quality-bloom-filters" class="md-nav__link">
    Using the Quality bloom filters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#expressions-which-take-expression-parameters" class="md-nav__link">
    Expressions which take expression parameters
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="bloom-filters">Bloom Filters<a class="headerlink" href="#bloom-filters" title="Permanent link">&para;</a></h1>
<p>Bloom Filters are probabalistic data structures that, for a given number of items and a false positive probability (FPP) provides a mightContain function.  This function <em>guarantees</em> that if an item is not in the bloom filter it will return false, however if it returns true this is to a probability defined by the FPP value.</p>
<p>In contrast to a Set which requires the items (or at least their hash values) to be stored individually blooms make use of multiple blocks and apply bit setting based on hashes of the input value over some function.  These resulting blocks and bitsets are far smaller in memory and storage usage than a typical set.  For example it's possible to store hundreds of millions of items within a bloom and still keep withn a normal Java byte array boundary.</p>
<p>This act of using bit flipping also allows blooms to be or'd for the same size and FPP, which is great for aggregation functions in Spark.</p>
<p>Whilst blooms are great the guarantees break when:</p>
<ol>
<li>The number of items far exceeds the initial size used to create the bloom - false is still guaranteed to not be present but the true value will no longer represent FPP, the bloom has degraded</li>
<li>The number of bits required to store the initial number of items at the FPP exceed what can be represented by the bloom algorithm.  </li>
</ol>
<p>If you attempt to store billions of items within a bloom at a high FPP you will quickly fall foul of 2, and this is easily done with both the Spark stats.package and the current bloom filters on Databricks.  This makes them next to useless for large dataset lookups on <em>typical</em> bloom implementations.</p>
<h2 id="how-does-quality-change-this">How does Quality change this?<a class="headerlink" href="#how-does-quality-change-this" title="Permanent link">&para;</a></h2>
<p>It can't change the fundemental laws of bloom filters, if you use the number of bits up your bloom filter is next to useless.  You <em>can</em> however add multiple Java byte arrays and bucket the hashes across them.  This works great up to about 1.5b items in a typical aggregation function within Spark, however Spark only allows a maximum of 2Gb for an InternalRow - of which aggregates are stored in.</p>
<p>Quality provides three bloom implementations the Spark stats package, small - which buckets within an InternalRow (1.2-1.5b items max whilst maintaining FPP) - and big which doesn't use Spark aggregations to store the results of aggregations but rather a shared file system such as Databricks dbfs.</p>
<p>Both the small and big bloom functions use Parquet's bloom filter implementation which both significantly faster and has better statistical properties than Sparks/Guavas or Breezes.</p>
<h2 id="what-are-bloom-maps">What are Bloom Maps?<a class="headerlink" href="#what-are-bloom-maps" title="Permanent link">&para;</a></h2>
<p>Bloom Maps are identifiers to a bloom filter.  The examples below show how to create the key is to use the SparkBloomFilter or bloomFilter functions to provide the value and the FPP is required.</p>
<div class="highlight"><pre><span></span><code><span class="n">registerBloomMapAndFunction</span><span class="p">(</span><span class="n">bloomFilterMap</span><span class="p">)</span>
</code></pre></div>
<p>Both registers the Bloom Map, the smallBloom and bigBloom aggregation functions and the probabilityIn function.</p>
<h2 id="using-the-spark-stats-package">Using the Spark stats package<a class="headerlink" href="#using-the-spark-stats-package" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="c1">// generate a dataframe with an id column</span>
<span class="kd">val</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqlContext</span><span class="p">.</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<span class="c1">// build a bloomfilter over the id&#39;s</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bloom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">bloomFilter</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span>
<span class="c1">// get the fpp and build the map</span>
<span class="kd">val</span><span class="w"> </span><span class="n">fpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bloom</span><span class="p">.</span><span class="n">expectedFpp</span><span class="p">()</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bloomFilterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">sparkContext</span><span class="p">.</span><span class="n">broadcast</span><span class="p">(</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;ids&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nc">SparkBloomFilter</span><span class="p">(</span><span class="n">bloom</span><span class="p">),</span><span class="w"> </span><span class="n">fpp</span><span class="p">))</span><span class="w"> </span><span class="p">)</span>

<span class="c1">// register the map for this SparkSession</span>
<span class="n">registerBloomMapAndFunction</span><span class="p">(</span><span class="n">bloomFilterMap</span><span class="p">)</span>
<span class="c1">// lookup the result of adding column&#39;s a and b against that bloom filter for each row</span>
<span class="n">otherSourceDF</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">&quot;probabilityInIds&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">(</span><span class="s">&quot;probabilityIn(a + b, &#39;ids&#39;)&quot;</span><span class="p">))</span>
</code></pre></div>
<p>The stats package bloomFilter function has severe limitations on a single field and does not allow expressions but through the SparkBloomFilter lookup function is integrated with Quality anyway.</p>
<h2 id="using-the-quality-bloom-filters">Using the Quality bloom filters<a class="headerlink" href="#using-the-quality-bloom-filters" title="Permanent link">&para;</a></h2>
<p>The small and big bloom functions take a single expression parameter however it can be built from any number of fields or field types.  Future versions will allow a flexible number of fields to be added to the hash function "see here" <a class="magiclink magiclink-github magiclink-issue" href="https://github.com/sparkutils/quality/issues/19" title="GitHub Issue: sparkutils/quality #19">#19</a>.</p>
<ul>
<li>smallBloom( column, expected number of items, fpp ) - an SQL aggregate function which generates a BloomFilter Array[Byte] for use in probabilityIn or rowId:
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">aggrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orig</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s">s&quot;smallBloom(uuid, </span><span class="si">$</span><span class="n">numRows</span><span class="s">, 0.01)&quot;</span><span class="p">)).</span><span class="n">head</span><span class="p">()</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">thebytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aggrow</span><span class="p">.</span><span class="n">getAs</span><span class="p">[</span><span class="nc">Bytes</span><span class="p">](</span><span class="mi">0</span><span class="p">)</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">bf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bloomLookup</span><span class="p">(</span><span class="n">thebytes</span><span class="p">)</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">fpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.99</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">blooms</span><span class="p">:</span><span class="w"> </span><span class="nc">BloomFilterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;ids&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">bf</span><span class="p">,</span><span class="w"> </span><span class="n">fpp</span><span class="p">))</span>
</code></pre></div></li>
<li>bigBloom( column, expected number of items, fpp ) - can only be run on large memory sized workers and executors and can cover billions of rows while maintaining the FPP:
<div class="highlight"><pre><span></span><code><span class="c1">// via the expression</span>
<span class="kd">val</span><span class="w"> </span><span class="n">interim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s">s&quot;bigBloom(</span><span class="si">$</span><span class="n">bloomOn</span><span class="s">, </span><span class="si">$</span><span class="n">expectedSize</span><span class="s">, </span><span class="si">$</span><span class="n">fpp</span><span class="s">, &#39;</span><span class="si">$</span><span class="n">bloomId</span><span class="s">&#39;)&quot;</span><span class="p">).</span><span class="n">head</span><span class="p">.</span><span class="n">getAs</span><span class="p">[</span><span class="nc">Array</span><span class="p">[</span><span class="nc">Byte</span><span class="p">]](</span><span class="mi">0</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bloom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="n">sparkutils</span><span class="p">.</span><span class="n">quality</span><span class="p">.</span><span class="n">impl</span><span class="p">.</span><span class="n">bloom</span><span class="p">.</span><span class="n">parquet</span><span class="p">.</span><span class="nc">BucketedFiles</span><span class="p">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">interim</span><span class="p">)</span>
<span class="n">bloom</span><span class="p">.</span><span class="n">cleanupOthers</span><span class="p">()</span>
<span class="n">bloom</span>
<span class="kd">val</span><span class="w"> </span><span class="n">blooms</span><span class="p">:</span><span class="w"> </span><span class="nc">BloomFilterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;ids&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">bloomLookup</span><span class="p">(</span><span class="n">bloom</span><span class="p">),</span><span class="w"> </span><span class="n">fpp</span><span class="p">))</span>

<span class="c1">// via the utility function, defaults to 0.01 fpp</span>
<span class="kd">val</span><span class="w"> </span><span class="n">bloom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bloomFrom</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expectedsize</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">blooms</span><span class="p">:</span><span class="w"> </span><span class="nc">BloomFilterMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;ids&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">bloomLookup</span><span class="p">(</span><span class="n">bloom</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bloom</span><span class="p">.</span><span class="n">fpp</span><span class="p">))</span>
</code></pre></div></li>
</ul>
<p>In testing the bigBloom creation over 1.5b rows on a small 4 node cluster took less than 8m to generate, using a resulting bloom however is far easier to load and distribute and constant time for lookups.  Whilst the actual big bloom itself cannot be directly broadcast only the file location of the resulting bloom is and each node on the cluster directly loads it from the ADLS (or other hopefully fast store for the multiple GBs).</p>
<p>To change the base location for blooms use the sparkSession.sparkContext.setLocalProperty("sparkutils.quality.bloom.root") to specify the location root.</p>
<h2 id="expressions-which-take-expression-parameters">Expressions which take expression parameters<a class="headerlink" href="#expressions-which-take-expression-parameters" title="Permanent link">&para;</a></h2>
<ul>
<li>probabilityIn( content to lookup, bloomfilterName ) - returns the fpp value of a filter lookup against the bloomFilter with bloomFilterName in the registered BloomFilterMap, which works with the Spark stats package, small and big blooms.</li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 2, 2023 22:35:34</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 2, 2023 22:35:34</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.expand", "content.code.copy"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
        <script src="../../js/jquery-3.6.3.min.js"></script>
      
        <script src="../../js/tagflipper.js"></script>
      
    
  </body>
</html>