
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://sparkutils.github.io/quality/0.1.3.1-RC7/advanced/processors/" rel="canonical"/>
<link href="../viewLoader/" rel="prev"/>
<link href="../../site/" rel="next"/>
<link href="../../img/quality.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.2" name="generator"/>
<title>Processors - Row By Row - Quality</title>
<link href="../../assets/stylesheets/main.7bf56d0a.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../stylesheets/site.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#stateful-expressions-ruin-the-fun">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<div data-md-color-scheme="default" data-md-component="outdated" hidden="">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Quality" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Quality">
<img alt="logo" src="../../img/quality.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Quality
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Processors - Row By Row
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/sparkutils/quality/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    Quality
  </div>
</a>
</div>
<a class="md-header__button md-header-nav__button md-icon" href="../../pdf/document.pdf" title="PDF">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
<path d="M128,0c-17.6,0-32,14.4-32,32v448c0,17.6,14.4,32,32,32h320c17.6,0,32-14.4,32-32V128L352,0H128z" fill="#E2E5E7"></path>
<path d="m384 128h96l-128-128v96c0 17.6 14.4 32 32 32z" fill="#B0B7BD"></path>
<polygon fill="#CAD1D8" points="480 224 384 128 480 128"></polygon>
<path d="M416,416c0,8.8-7.2,16-16,16H48c-8.8,0-16-7.2-16-16V256c0-8.8,7.2-16,16-16h352c8.8,0,16,7.2,16,16  V416z" fill="#F15642"></path>
<g fill="#fff">
<path d="m101.74 303.15c0-4.224 3.328-8.832 8.688-8.832h29.552c16.64 0 31.616 11.136 31.616 32.48 0 20.224-14.976 31.488-31.616 31.488h-21.36v16.896c0 5.632-3.584 8.816-8.192 8.816-4.224 0-8.688-3.184-8.688-8.816v-72.032zm16.88 7.28v31.872h21.36c8.576 0 15.36-7.568 15.36-15.504 0-8.944-6.784-16.368-15.36-16.368h-21.36z"></path>
<path d="m196.66 384c-4.224 0-8.832-2.304-8.832-7.92v-72.672c0-4.592 4.608-7.936 8.832-7.936h29.296c58.464 0 57.184 88.528 1.152 88.528h-30.448zm8.064-72.912v57.312h21.232c34.544 0 36.08-57.312 0-57.312h-21.232z"></path>
<path d="m303.87 312.11v20.336h32.624c4.608 0 9.216 4.608 9.216 9.072 0 4.224-4.608 7.68-9.216 7.68h-32.624v26.864c0 4.48-3.184 7.92-7.664 7.92-5.632 0-9.072-3.44-9.072-7.92v-72.672c0-4.592 3.456-7.936 9.072-7.936h44.912c5.632 0 8.96 3.344 8.96 7.936 0 4.096-3.328 8.704-8.96 8.704h-37.248v0.016z"></path>
</g>
<path d="m400 432h-304v16h304c8.8 0 16-7.2 16-16v-16c0 8.8-7.2 16-16 16z" fill="#CAD1D8"></path>
</svg>
</a></nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../getting_started/">
        Getting Started
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../background/about/">
        About
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../model/">
        Model
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../blooms/">
        Advanced Usage
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../site/">
      Maven Site
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../site/scaladocs/com/sparkutils/quality/">
      Scala Docs
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../sqlfunctions/">
      SQL Functions Documentation
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Quality" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Quality">
<img alt="logo" src="../../img/quality.png"/>
</a>
    Quality
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/sparkutils/quality/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    Quality
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/">
        Building and Setting Up
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/a_first_rulesuite/">
        Defining &amp; Running your first RuleSuite
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/flavours/">
        Those are some Quality flavours
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/key_functions/">
        Key SQL Functions to use in your Rules
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/serializing/">
        Reading &amp; Writing RuleSuites
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/running_on_databricks/">
        Running Quality on Databricks
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting_started/running_on_fabric/">
        Running Quality on Fabric
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          About
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          About
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../background/about/">
        History
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Performance Choices
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
          Performance Choices
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../background/evaluation_method/">
        Evaluation Method
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../background/storage_method/">
        Storage Method
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../background/changelog/">
        Changelog
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Model
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Model
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../model/">
        Rule Model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model/storage/">
        Storage Model
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../model/meta/">
        Meta Rulesets?
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Advanced Usage
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          Advanced Usage
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../blooms/">
        Bloom Filters
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../mapFunctions/">
        Map Functions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aggregations/">
        Aggregation Functions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../userFunctions/">
        User Defined Functions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../prng/">
        PRNG Functions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../rowIdFunctions/">
        Row ID Functions
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
          QualityRules
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_7">
<span class="md-nav__icon md-icon"></span>
          QualityRules
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../ruleEngine/">
        Engine
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ruleEngineWorkflow/">
        Workflow
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ruleFolder/">
        QualityFolder
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../expressionRunner/">
        QualityExpressions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../validation/">
        Validation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../expressionDocs/">
        Expression Documentation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../viewLoader/">
        View Loading
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Processors - Row By Row
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Processors - Row By Row
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#stateful-expressions-ruin-the-fun">
    Stateful expressions ruin the fun
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thread-safety">
    Thread Safety
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#partitions-initialize">
    Partitions / initialize?
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encoders-and-input-types">
    Encoders and Input types
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-functions">
    Map Functions
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../site/">
        Maven Site
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../site/scaladocs/com/sparkutils/quality/">
        Scala Docs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sqlfunctions/">
        SQL Functions Documentation
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#stateful-expressions-ruin-the-fun">
    Stateful expressions ruin the fun
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thread-safety">
    Thread Safety
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#partitions-initialize">
    Partitions / initialize?
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#encoders-and-input-types">
    Encoders and Input types
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#map-functions">
    Map Functions
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Processors - Row By Row</h1>
<p>Quality Processors allow for Quality rules to be used on a jvm outside of Spark execution.  Spark is required for expression resolution and compilation so the pattern of usage is:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">sparkutils</span><span class="p">.</span><span class="nn">quality</span><span class="p">.</span><span class="nn">sparkless</span><span class="p">.</span><span class="nc">ProcessFunctions</span><span class="p">.</span><span class="n">_</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">InputData</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">sparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">().</span>
<span class="w">  </span><span class="n">config</span><span class="p">(</span><span class="s">"spark.master"</span><span class="p">,</span><span class="w"> </span><span class="s">s"local[1]"</span><span class="p">).</span>
<span class="w">  </span><span class="n">config</span><span class="p">(</span><span class="s">"spark.ui.enabled"</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">).</span><span class="n">getOrCreate</span><span class="p">()</span>

<span class="n">registerQualityFunctions</span><span class="p">()</span><span class="w"> </span><span class="c1">// optional</span>

<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ruleSuite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// get rulesuite</span>
<span class="w">  </span><span class="k">import</span><span class="w"> </span><span class="nn">sparkSession</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>
<span class="w">  </span><span class="c1">// thread safe to share</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">processorFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dqFactory</span><span class="p">[</span><span class="nc">InputData</span><span class="p">](</span><span class="n">ruleSuite</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">// in other threads an instance is needed</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">threadSpecificProcessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processorFactory</span><span class="p">.</span><span class="n">instance</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">dqResults</span><span class="p">:</span><span class="w"> </span><span class="nc">RuleSuiteResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadSpecificProcessor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">InputData</span><span class="p">(...))</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// when your thread is finished doing work close the instance</span>
<span class="w">    </span><span class="n">threadSpecificProcessor</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sparkSession</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="stateful-expressions-ruin-the-fun">Stateful expressions ruin the fun<a class="headerlink" href="#stateful-expressions-ruin-the-fun" title="Permanent link">¶</a></h3>
<p>Given the comment about "no Spark execution" why is a sparkSession present?  The Spark infrastructure is used to compile code, this requires a running spark task or session to obtain configuration and access to the implicits for encoder derivation.  <strong>IF</strong> the rules do not include stateful expressions (why would they?) and you use the default compilation this is also possible:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">sparkutils</span><span class="p">.</span><span class="nn">quality</span><span class="p">.</span><span class="nn">sparkless</span><span class="p">.</span><span class="nc">ProcessFunctions</span><span class="p">.</span><span class="n">_</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">InputData</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">sparkSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">.</span><span class="n">builder</span><span class="p">().</span>
<span class="w">  </span><span class="n">config</span><span class="p">(</span><span class="s">"spark.master"</span><span class="p">,</span><span class="w"> </span><span class="s">s"local[1]"</span><span class="p">).</span>
<span class="w">  </span><span class="n">config</span><span class="p">(</span><span class="s">"spark.ui.enabled"</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">).</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="kd">val</span><span class="w"> </span><span class="n">ruleSuite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// get rulesuite</span>
<span class="k">import</span><span class="w"> </span><span class="nn">sparkSession</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>
<span class="c1">// thread safe to share</span>
<span class="kd">val</span><span class="w"> </span><span class="n">processorFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dqFactory</span><span class="p">[</span><span class="nc">InputData</span><span class="p">](</span><span class="n">ruleSuite</span><span class="p">)</span>

<span class="n">sparkSession</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>

<span class="c1">// in other threads an instance is needed</span>
<span class="kd">val</span><span class="w"> </span><span class="n">threadSpecificProcessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processorFactory</span><span class="p">.</span><span class="n">instance</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">threadSpecificProcessor</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">partitionId</span><span class="p">)</span><span class="w"> </span><span class="c1">// Optional, see below Partitions note</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">dqResults</span><span class="p">:</span><span class="w"> </span><span class="nc">RuleSuiteResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadSpecificProcessor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">InputData</span><span class="p">(...))</span>
<span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// when your thread is finished doing work close the instance</span>
<span class="w">  </span><span class="n">threadSpecificProcessor</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>The above bold IF is ominous, why the caveat?  Stateful expressions using compilation are fine, the state handling is moved to the compiled code.  If, however, the expressions are "CodegenFallback" and run in interpreted mode then each thread needs its own state.  The same is true for using compile = false as a parameter, as such it's recommended to stick with defaults and avoid stateful expressions such as monotonically_incrementing_id, rand or unique_id.</p>
<p>If the rules are free of such stateful expressions then the .instance function is nothing more than a call to a constructor on pre-compiled code.</p>
<p>In short, given stateful expressions can provide different answers for the same inputs it's something to be avoided unless you really need that behaviour.</p>
<h3 id="thread-safety">Thread Safety<a class="headerlink" href="#thread-safety" title="Permanent link">¶</a></h3>
<p>In all combinations of ProcessorFactory's the factory itself is thread safe and may be shared, the instances themselves are not and use mutable state to achieve performance.</p>
<h3 id="partitions-initialize">Partitions / initialize?<a class="headerlink" href="#partitions-initialize" title="Permanent link">¶</a></h3>
<p>Despite all the above commentary on Stateful expressions being awkward to use, if you choose to then you should use the initialize function with a unique integer parameter for each thread.</p>
<p>If you are not using stateful expressions you don't need to call initialize.</p>
<h2 id="encoders-and-input-types">Encoders and Input types<a class="headerlink" href="#encoders-and-input-types" title="Permanent link">¶</a></h2>
<p>The output types of all the runners are well-defined but, like the input types, rely on Spark Encoder's to abstract from the actual types.</p>
<p>For simple beans it's enough to use the Spark Encoders.bean(Class[_]) to derive an encoder or, when using Scala, Frameless encoding derivation.</p>
<div class="admonition note">
<p class="admonition-title">Java Lists and Maps need special care</p>
<p>Using Java lists or maps with Encoders.bean doesn't work very often, the type information isn't available to the Spark code.</p>
<p>In Spark 3.4 and above you can use AgnosticEncoders instead and specify the types.</p>
</div>
<p>What about something more interesting like an Avro message? </p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">testOnAvro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SchemaBuilder</span><span class="p">.</span><span class="n">record</span><span class="p">(</span><span class="s">"testOnAvro"</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">namespace</span><span class="p">(</span><span class="s">"com.teston"</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">fields</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">requiredString</span><span class="p">(</span><span class="s">"product"</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">requiredString</span><span class="p">(</span><span class="s">"account"</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">requiredInt</span><span class="p">(</span><span class="s">"subcode"</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">endRecord</span><span class="p">()</span>
<span class="kd">val</span><span class="w"> </span><span class="n">datumWriter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GenericDatumWriter</span><span class="p">[</span><span class="nc">GenericRecord</span><span class="p">](</span><span class="n">testOnAvro</span><span class="p">);</span>

<span class="kd">val</span><span class="w"> </span><span class="n">bos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ByteArrayOutputStream</span><span class="p">()</span>
<span class="kd">val</span><span class="w"> </span><span class="n">enc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">EncoderFactory</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">binaryEncoder</span><span class="p">(</span><span class="n">bos</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">avroTestData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">testData</span><span class="p">.</span><span class="n">map</span><span class="p">{</span><span class="n">d</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">GenericData</span><span class="p">.</span><span class="nc">Record</span><span class="p">(</span><span class="n">testOnAvro</span><span class="p">)</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">"product"</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">product</span><span class="p">)</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">"account"</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">account</span><span class="p">)</span>
<span class="w">  </span><span class="n">r</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">"subcode"</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">subcode</span><span class="p">)</span>
<span class="w">  </span><span class="n">datumWriter</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">enc</span><span class="p">)</span>
<span class="w">  </span><span class="n">enc</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bos</span><span class="p">.</span><span class="n">toByteArray</span>
<span class="w">  </span><span class="n">bos</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
<span class="w">  </span><span class="n">ba</span>
<span class="p">}</span>

<span class="k">import</span><span class="w"> </span><span class="nn">s</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">processorFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ProcessFunctions</span><span class="p">.</span><span class="n">dqFactory</span><span class="p">[</span><span class="nc">Array</span><span class="p">[</span><span class="nc">Byte</span><span class="p">]](</span><span class="n">rs</span><span class="p">,</span><span class="w"> </span><span class="n">inCodegen</span><span class="p">,</span><span class="w"> </span><span class="n">extraProjection</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">_</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">"vals"</span><span class="p">,</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">avro</span><span class="p">.</span><span class="n">functions</span><span class="p">.</span><span class="n">from_avro</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">"value"</span><span class="p">),</span><span class="w"> </span><span class="n">testOnAvro</span><span class="p">.</span><span class="n">toString</span><span class="p">)).</span>
<span class="w">    </span><span class="n">select</span><span class="p">(</span><span class="s">"vals.*"</span><span class="p">))</span>
<span class="w">  </span><span class="p">...</span>
</code></pre></div>
<p>extraProjection allows conversion based on existing Spark conversion functions.</p>
<h2 id="map-functions">Map Functions<a class="headerlink" href="#map-functions" title="Permanent link">¶</a></h2>
<p>As correlated subqueries cannot be run outside of Spark the Quality Map functions must be used:</p>
<div class="highlight"><pre><span></span><code><span class="n">registerQualityFunctions</span><span class="p">()</span>

<span class="kd">val</span><span class="w"> </span><span class="n">theMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Seq</span><span class="p">((</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">lookups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapLookupsFromDFs</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span>
<span class="w">  </span><span class="s">"subcodes"</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">theMap</span><span class="p">.</span><span class="n">toDF</span><span class="p">(</span><span class="s">"subcode"</span><span class="p">,</span><span class="w"> </span><span class="s">"isvalid"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">(</span><span class="s">"subcode"</span><span class="p">),</span><span class="w"> </span><span class="n">column</span><span class="p">(</span><span class="s">"isvalid"</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="p">)</span>
<span class="p">),</span><span class="w"> </span><span class="nc">LocalBroadcast</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>

<span class="n">registerMapLookupsAndFunction</span><span class="p">(</span><span class="n">lookups</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RuleSuite</span><span class="p">(</span><span class="nc">Id</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">  </span><span class="nc">RuleSet</span><span class="p">(</span><span class="nc">Id</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">Seq</span><span class="p">(</span>
<span class="w">    </span><span class="nc">Rule</span><span class="p">(</span><span class="nc">Id</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="nc">ExpressionRule</span><span class="p">(</span><span class="s">"if(product like '%otc%', account = '4201', mapLookup('subcodes', subcode))"</span><span class="p">))</span>
<span class="w">  </span><span class="p">))</span>
<span class="p">))</span>
</code></pre></div>
<p>Note the use of LocalBroadcast, this implementation of Sparks Broadcast can be used without a SparkSession and just wraps the value.</p>
<hr/>
<div class="md-source-file">
<small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 23, 2025 22:04:21</span>
<br/>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">May 23, 2025 22:04:21</span>
</small>
</div>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" hidden="" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.expand", "content.code.copy"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
<script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
<script src="../../js/jquery-3.6.3.min.js"></script>
<script src="../../js/tagflipper.js"></script>
</body>
</html>